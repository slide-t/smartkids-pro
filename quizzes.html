<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Quiz Hub CBT</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body { margin:0; font-family:Arial,sans-serif; background:#f4f6f8; }
h2 { position:sticky; top:0; background:#003366; color:#fff; padding:12px; text-align:center; }

.header-bar {
  display:flex; justify-content:space-between; padding:10px;
  background:#e9eef3; font-size:14px;
}
.timer { background:#003366; color:#fff; text-align:center; padding:8px; }

#quizArea { padding:15px; }
.question-box {
  background:#fff; margin-bottom:15px; padding:12px; border-radius:6px;
}
.option { display:block; padding:6px 0; }

button {
  width:90%; max-width:400px; margin:15px auto; display:block;
  padding:12px; background:#003366; color:#fff;
  border:none; border-radius:6px; font-size:16px;
}

.modal {
  position:fixed; inset:0; background:rgba(0,0,0,.6);
  display:flex; justify-content:center; align-items:center; z-index:50;
}
.modal-content {
  background:#fff; padding:20px; text-align:center;
  border-radius:8px; width:90%; max-width:350px;
}
</style>
</head>

<body>

<h2>Quiz Hub CBT</h2>

<div class="header-bar">
  <div>Set: <span id="setCount">1</span>/5</div>
  <div><b>Score:</b> <span id="score">0</span></div>
</div>

<div class="timer">Time Left: <span id="time">00:00</span></div>
<div id="quizArea"></div>
<button id="submitBtn">Submit</button>

<!-- STUDENT MODAL -->
<div class="modal" id="studentModal">
  <div class="modal-content">
    <h3>Student Details</h3>
<input id="studentName"
  placeholder="Full Name" style=" width:100%;
    padding:14px; font-size:16px;
    border-radius:6px; border:1px solid #ccc;">
<br><br>

<select
  id="studentClass"
  style="
    width:100%;
    padding:14px;
    font-size:16px;
    border-radius:6px;
    border:1px solid #ccc;
  "
>
    
    <!--<input id="studentName" placeholder="Full Name" style="width:100%;padding:8px"><br><br>
    <select id="studentClass" style="width:100%;padding:8px">-->
      <option value="">Select Class</option>
      <option>Primary 1</option><option>Primary 2</option><option>Primary 3</option>
      <option>Primary 4</option><option>Primary 5</option><option>Primary 6</option>
      <option>JSS 1</option><option>JSS 2</option><option>JSS 3</option>
      <option>SSS 1</option><option>SSS 2</option><option>SSS 3</option>
    </select><br><br>
    <button onclick="saveStudent()">Continue</button>
  </div>
</div>

<!-- LEVEL MODAL -->
<div class="modal" id="levelModal" style="display:none">
  <div class="modal-content">
    <h3>Select Level</h3>
    <button onclick="startQuiz('primary')">Primary</button>
    <button onclick="startQuiz('secondary')">Secondary</button>
  </div>
</div>

<!-- FAIL MODAL -->
<div class="modal" id="failModal" style="display:none">
  <div class="modal-content">
    <p id="finalScore"></p>
    <button onclick="restartQuiz()">Ok</button>
  </div>
</div>
  
<!-- RESULT MODAL -->
<div class="modal" id="failModal" style="display:none">
  <div class="modal-content">
    <p id="finalScore"></p>

    <!-- Existing print button -->
    <button onclick="window.print()">Print Result</button>

    <!-- Optional PDF export -->
    <button onclick="exportResultPDF()">Download Result (PDF)</button>

    <!-- Existing restart button -->
    <button onclick="restartQuiz()">Ok</button>
  </div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
let allQuestions = [];
let currentSet = [];
let totalScore = 0;
let currentSetNumber = 1;
const MAX_SETS = 5;
const QUESTIONS_PER_SET = 5;
let quizTime = 10 * 60;
let timerInterval;
let timerStarted = false;
let student = {};
let tabSwitches = 0;

// ===============================
// TIMER
// ===============================
function startTimer() {
  if (timerStarted) return;
  timerStarted = true;

  timerInterval = setInterval(() => {
    const min = Math.floor(quizTime / 60);
    const sec = quizTime % 60;
    document.getElementById("time").textContent =
      `${min}:${sec.toString().padStart(2,"0")}`;

    if (quizTime <= 0) {
      clearInterval(timerInterval);
      endQuiz();
    }
    quizTime--;
  }, 1000);
}

// ===============================
// SAVE STUDENT DETAILS
// ===============================
function saveStudent() {
  const name = document.getElementById("studentName").value.trim();
  const studentClass = document.getElementById("studentClass").value.trim();

  if (!name || !studentClass) {
    alert("Please enter your full name and class");
    return;
  }

  student = { name, class: studentClass };
  studentModal.style.display = "none";
  levelModal.style.display = "flex";
}

// ===============================
// START QUIZ
// ===============================
function startQuiz(level) {
  levelModal.style.display = "none";
  totalScore = 0;
  currentSetNumber = 1;
  quizTime = 10 * 60;
  timerStarted = false;
  tabSwitches = 0;

  const quizFile = level === "primary"
    ? "json-files/quiz-hub/quiz-prim.json"
    : "json-files/quiz-hub/quiz-sec.json";

  fetch(quizFile)
    .then(res => res.json())
    .then(data => {
      allQuestions = shuffle(
        data.questions.map(q => ({
          question: q.question,
          options: shuffle(
            q.options.map((text,index)=>({
              text,
              isCorrect: index === q.answer
            }))
          )
        }))
      );
      loadSet();
      startTimer();
    })
    .catch(err => {
      alert("Failed to load quiz. Check JSON path.");
      console.error(err);
    });
}

// ===============================
// LOAD SET
// ===============================
function loadSet() {
  window.scrollTo(0,0);
  document.getElementById("score").textContent = totalScore;
  document.getElementById("setCount").textContent = currentSetNumber;

  const quizArea = document.getElementById("quizArea");
  quizArea.innerHTML = "";
  currentSet = allQuestions.splice(0, QUESTIONS_PER_SET);

  currentSet.forEach((q, i) => {
    quizArea.innerHTML += `
      <div class="question-box">
        <h4>${i+1}. ${q.question}</h4>
        ${q.options.map((opt, idx)=>`
          <label class="option">
            <input type="radio" name="q${i}" value="${idx}">
            ${opt.text}
          </label>
        `).join("") }
      </div>
    `;
  });

  // Highlight selected option
  quizArea.querySelectorAll(".option input").forEach(input => {
    input.addEventListener("change", e => {
      const parent = e.target.closest(".question-box");
      parent.querySelectorAll(".option").forEach(l => l.classList.remove("selected"));
      e.target.closest(".option").classList.add("selected");
    });
  });
}

// ===============================
// SUBMIT
// ===============================
document.getElementById("submitBtn").onclick = () => {
  const unanswered = currentSet.some((q,i)=>!document.querySelector(`input[name=q${i}]:checked`));
  if (unanswered) {
    alert("Please answer all questions before submitting!");
    return;
  }

  currentSet.forEach((q,i)=>{
    const chosen = document.querySelector(`input[name=q${i}]:checked`);
    if(chosen && q.options[parseInt(chosen.value)].isCorrect){
      totalScore++;
    }
  });

  if(++currentSetNumber <= MAX_SETS){
    loadSet();
  } else {
    endQuiz();
  }
};

// ===============================
// END QUIZ
// ===============================
function endQuiz() {
  clearInterval(timerInterval);
  const total = MAX_SETS * QUESTIONS_PER_SET;
  const passMark = Math.ceil(total * 0.5);
  const status = totalScore >= passMark ? "PASS ✅" : "FAIL ❌";

  const resultText =
    `STUDENT RESULT\n\n` +
    `Name: ${student.name}\n` +
    `Class: ${student.class}\n\n` +
    `Score: ${totalScore} / ${total}\n` +
    `Status: ${status}\n\n` +
    `Date: ${new Date().toLocaleString()}`;

  document.getElementById("finalScore").textContent = resultText;
  failModal.style.display = "flex";
}

// ===============================
// EXPORT RESULT PDF
// ===============================
function exportResultPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  const total = MAX_SETS * QUESTIONS_PER_SET;
  const passMark = Math.ceil(total * 0.5);
  const status = totalScore >= passMark ? "PASS ✅" : "FAIL ❌";

  let y = 20;
  doc.setFontSize(16);
  doc.text("QUIZ HUB CBT RESULT", 105, y, { align: "center" });
  y+=15;
  doc.setFontSize(12);
  doc.text(`Student Name: ${student.name}`, 20, y); y+=8;
  doc.text(`Class: ${student.class}`, 20, y); y+=8;
  doc.text(`Score: ${totalScore} / ${total}`, 20, y); y+=8;
  doc.text(`Status: ${status}`, 20, y); y+=8;
  doc.text(`Date: ${new Date().toLocaleString()}`, 20, y);
  y+=15;
  doc.setFontSize(10);
  doc.text(
    "This result was generated electronically by Quiz Hub CBT.\nNo signature required.",
    20,
    y
  );
  doc.save(`${student.name.replace(/\s+/g,"_")}_CBT_Result.pdf`);
}

// ===============================
// RESTART QUIZ
// ===============================
function restartQuiz() { location.reload(); }

// ===============================
// SHUFFLE
// ===============================
function shuffle(arr) { return arr.sort(()=>Math.random()-0.5); }

// ===============================
// MODAL ONLOAD
// ===============================
window.onload = () => { studentModal.style.display = "flex"; };

// ===============================
// ANTI-CHEAT: detect tab switch
// ===============================
document.addEventListener("visibilitychange", () => {
  if(document.hidden){
    tabSwitches++;
    if(tabSwitches >= 2){
      alert("Quiz submitted due to tab switching!");
      document.getElementById("submitBtn").click();
    } else {
      alert("⚠ Warning: Do not switch tabs! Next attempt will auto-submit the quiz.");
    }
  }
});
</script>

  

  
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</body>
</html>
