<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SmartKids-Pro — Keyboard Tutor</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* keyboard key base */
    .vk { 
      transition: all .12s ease; 
      width: 3.1rem; height: 3.1rem;
      display:flex; align-items:center; justify-content:center;
      border-radius:.5rem; box-shadow: 0 6px 14px rgba(2,6,23,0.25);
      background: linear-gradient(180deg,#0f172a,#0b1220);
      color: #f8fafc; font-weight:600; user-select:none;
      opacity: 0.35; /* subtle until used */
    }
    .vk.visible { opacity: 1; background: linear-gradient(180deg,#1e293b,#111827); }
    .vk.active { transform: translateY(-4px) scale(1.02); background:#2563eb; color:white; }
    .vk.correct { background:#16a34a; color:white; }
    .vk.wrong { background:#ef4444; color:white; }
    .vk.next { box-shadow: 0 0 14px rgba(59,130,246,0.6); background: linear-gradient(180deg,#60a5fa,#3b82f6); color:#042a42; opacity:1; }
    .char { display:inline-block; padding:.06rem .18rem; border-radius:4px; }
    .char.current { background:#93c5fd; color:#062a2d; }
    .char.correct { background:#bbf7d0; color:#064e3b; }
    .char.wrong { background:#fecaca; color:#7f1d1d; }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-b from-sky-50 to-indigo-50 text-slate-900 antialiased">
  <div class="max-w-5xl mx-auto px-4 py-8">

    <header class="flex items-center justify-between mb-6">
      <h1 class="text-2xl font-extrabold">SmartKids-Pro — Keyboard Tutor</h1>
      <div class="text-sm text-slate-600">Professional progressive typing • strict mastery</div>
    </header>

    <main class="bg-white rounded-2xl p-6 shadow-lg">
      <section class="mb-4">
        <div id="lessonTitle" class="text-lg font-semibold text-indigo-700"></div>
        <div id="hints" class="text-sm text-slate-600 mt-2"></div>
      </section>

      <section class="mb-6">
        <div id="practiceText" class="font-mono text-xl leading-relaxed text-slate-800 bg-slate-100 p-4 rounded"></div>
      </section>

      <section class="flex gap-4 items-center mb-4">
        <div class="flex gap-3 items-center">
          <button id="startBtn" class="px-4 py-2 bg-indigo-600 text-white rounded shadow hover:bg-indigo-500">Start Attempt</button>
          <button id="resetBtn" class="px-3 py-2 border rounded text-slate-700">Reset Attempt</button>
        </div>

        <div class="ml-auto text-sm text-slate-600">
          <span id="attemptInfo">Attempt: 0</span> • <span id="timeInfo">00:00</span>
        </div>
      </section>

      <section class="mb-6">
        <div id="stats" class="flex gap-4 text-sm text-slate-700">
          <div>Accuracy: <span id="accuracy">0%</span></div>
          <div>Errors: <span id="errors">0</span></div>
          <div>Consec Passes: <span id="passes">0</span></div>
        </div>
      </section>

      <!-- Keyboard layout area -->
      <section class="mt-6">
        <div id="keyboardArea" class="bg-slate-900 p-6 rounded-xl">
          <!-- rows will be injected -->
        </div>
      </section>

      <section class="mt-6 flex justify-between items-center">
        <div class="text-sm text-slate-600">Progress saved locally</div>
        <div>
          <button id="forceNextBtn" class="px-4 py-2 bg-green-600 text-white rounded hidden">Next Lesson</button>
        </div>
      </section>
    </main>
  </div>

<script>
/* ---------- configuration ---------- */
const JSON_PATH = 'json-files/keyboard.json';
/* ---------- state ---------- */
let lessons = [];
let lessonIndex = 0;
let currentText = '';
let charIndex = 0;
let attemptCount = 0;
let errorsCount = 0;
let startTime = 0;
let timerInterval = null;
let consecutivePasses = 0;
let attemptStats = []; // array of past attempts (optional)
let localKeyMap = {}; // from key string -> dom id

/* ---------- helper UI nodes ---------- */
const lessonTitle = document.getElementById('lessonTitle');
const practiceText = document.getElementById('practiceText');
const hintsEl = document.getElementById('hints');
const startBtn = document.getElementById('startBtn');
const resetBtn = document.getElementById('resetBtn');
const timeInfo = document.getElementById('timeInfo');
const attemptInfo = document.getElementById('attemptInfo');
const accuracyEl = document.getElementById('accuracy');
const errorsEl = document.getElementById('errors');
const passesEl = document.getElementById('passes');
const keyboardArea = document.getElementById('keyboardArea');
const forceNextBtn = document.getElementById('forceNextBtn');

/* ---------- keyboard layout rows (render exactly like a real keyboard) ---------- */
const KEY_LAYOUT = [
  ['`','1','2','3','4','5','6','7','8','9','0','-','='],
  ['Tab','q','w','e','r','t','y','u','i','o','p','[',']','\\'],
  ['Caps','a','s','d','f','g','h','j','k','l',';','\'','Enter'],
  ['Shift','z','x','c','v','b','n','m',',','.','/','Shift'],
  ['Space']
];

/* ---------- fetch lessons ---------- */
fetch(JSON_PATH)
  .then(r => r.json())
  .then(json => {
    lessons = json.lessons || [];
    // resume saved lesson
    const saved = JSON.parse(localStorage.getItem('skp-lesson-state') || '{}');
    if (saved.lessonIndex != null) lessonIndex = saved.lessonIndex;
    loadLesson(lessonIndex);
    renderKeyboard();
    // attach keyboard events
    document.addEventListener('keydown', onKeyDown);
    startBtn.addEventListener('click', startAttempt);
    resetBtn.addEventListener('click', resetAttempt);
    forceNextBtn.addEventListener('click', () => { nextLesson(); });
  })
  .catch(err => {
    console.error(err);
    lessonTitle.textContent = 'Failed to load lessons.';
  });

/* ---------- load a lesson ---------- */
function loadLesson(i) {
  if (i < 0 || i >= lessons.length) {
    lessonTitle.textContent = 'All lessons completed — well done!';
    practiceText.innerHTML = '';
    hintsEl.textContent = '';
    return;
  }
  lessonIndex = i;
  const L = lessons[i];
  currentText = L.text;
  charIndex = 0;
  attemptCount = 0;
  errorsCount = 0;
  consecutivePasses = parseInt(localStorage.getItem('skp-consec') || '0');
  updateUI();
  renderPracticeText();
  hintsEl.textContent = L.hints || '';
  saveState();
}

/* ---------- render practice text with spans ---------- */
function renderPracticeText() {
  const html = currentText.split('').map((ch, idx) => {
    const cls = idx === charIndex ? 'char current' : 'char';
    // encode html special chars
    const chEsc = ch === ' ' ? '&nbsp;' : escapeHtml(ch);
    return `<span data-idx="${idx}" class="${cls}">${chEsc}</span>`
  }).join('');
  practiceText.innerHTML = html;
}

/* ---------- keyboard UI build ---------- */
function renderKeyboard() {
  keyboardArea.innerHTML = '';
  KEY_LAYOUT.forEach(row => {
    const rowDiv = document.createElement('div');
    rowDiv.className = 'flex gap-2 mb-3 justify-center';
    row.forEach(key => {
      const k = document.createElement('div');
      k.className = 'vk';
      k.dataset.key = key.toLowerCase();
      k.id = `vk-${sanitizeId(key)}`;
      k.innerHTML = `<div style="font-size:0.9rem">${escapeHtml(key)}</div>`;
      // make space key wider
      if (key === 'Space') k.style.width = '38rem';
      if (key === 'Shift') k.style.width = '6.5rem';
      if (key === 'Enter' || key === 'Backspace' || key === 'Caps') k.style.width = '6rem';
      rowDiv.appendChild(k);
      localKeyMap[key.toLowerCase()] = k.id;
      // on-screen click should simulate press
      k.addEventListener('mousedown', (ev) => {
        simulateVirtualPress(key.toLowerCase());
        ev.preventDefault();
      });
    });
    keyboardArea.appendChild(rowDiv);
  });
}

/* ---------- start attempt ---------- */
function startAttempt() {
  if (!currentText) return;
  attemptCount++;
  attemptInfo.textContent = `Attempt: ${attemptCount}`;
  errorsCount = 0;
  errorsEl.textContent = errorsCount;
  charIndex = 0;
  renderPracticeText();
  startTimer();
  // make next expected key glow
  updateNextKeyGlow();
}

/* ---------- reset attempt ---------- */
function resetAttempt() {
  stopTimer();
  attemptCount = 0;
  errorsCount = 0;
  charIndex = 0;
  attemptInfo.textContent = `Attempt: ${attemptCount}`;
  errorsEl.textContent = errorsCount;
  accuracyEl.textContent = '0%';
  renderPracticeText();
  updateNextKeyGlow();
}

/* ---------- timer ---------- */
function startTimer() {
  stopTimer();
  startTime = Date.now();
  timeInfo.textContent = '00:00';
  timerInterval = setInterval(() => {
    const s = Math.floor((Date.now() - startTime) / 1000);
    timeInfo.textContent = formatSeconds(s);
  }, 300);
}
function stopTimer() { if (timerInterval) { clearInterval(timerInterval); timerInterval = null; } }
function formatSeconds(s) { const m = Math.floor(s/60).toString().padStart(2,'0'); const sec = (s%60).toString().padStart(2,'0'); return `${m}:${sec}`; }

/* ---------- key processing ---------- */
function onKeyDown(e) {
  // block if not started
  if (attemptCount === 0) return;

  const raw = normalizeKey(e);
  if (!raw) return;

  // map display keys to character to compare to currentText
  const targetChar = currentText[charIndex] || null;
  const keyForCompare = keyToChar(raw, e);

  // visual feedback
  flashKey(raw);

  // handle backspace
  if (raw === 'backspace') {
    if (charIndex > 0) {
      charIndex--;
      markChar(charIndex, null); // remove marking
      renderPracticeText();
      updateNextKeyGlow();
    }
    return;
  }

  // convert targetChar to comparable char
  if (!targetChar) return; // nothing more to do

  // compare typed char to expected (exact match including punctuation & case)
  const expected = targetChar;
  // we match case-sensitive to enforce capitals and punctuation. If you want case-insensitive, lower both.
  const correct = (keyForCompare === expected);

  if (correct) {
    markChar(charIndex, 'correct');
    charIndex++;
    renderPracticeText();
    updateNextKeyGlow();

    // if finished the line
    if (charIndex >= currentText.length) {
      stopTimer();
      const timeTaken = Math.round((Date.now() - startTime) / 1000);
      const acc = computeAccuracy();
      recordAttempt(acc, errorsCount, timeTaken);
      evaluatePass(acc, errorsCount);
    }
  } else {
    // wrong char
    errorsCount++;
    errorsEl.textContent = errorsCount;
    markChar(charIndex, 'wrong'); // visually mark
    flashWrong(raw);
    // optional: impose penalty: require retyping the character correctly before moving on
  }
}

/* ---------- utilities for char/key normalization ---------- */
function normalizeKey(e) {
  // handle special keys by name
  const k = e.key;
  if (!k) return null;
  const lower = k.toLowerCase();
  if (lower === ' ') return 'space';
  if (lower === 'arrowleft' || lower === 'arrowright' || lower === 'tab') return null; // ignore
  if (lower === 'enter') return 'enter';
  if (lower === 'backspace') return 'backspace';
  // map shift keys
  return lower;
}
function keyToChar(keyName, e) {
  // Map the key name to the character to compare against expected text
  // If keyName is 'space' -> ' '
  if (keyName === 'space') return ' ';
  if (keyName === 'enter') return '\n';
  if (keyName === 'backspace') return null;
  // For punctuation keys, e.key already gives the precise char respecting shift (e.g., '?' or ':')
  // But since we call this from normalized key with no event sometimes, we accept lower-case letter
  // We attempt to use e.key if available
  if (e && e.key) return e.key;
  return keyName;
}

/* ---------- mark char in practice text (visual) ---------- */
function markChar(idx, status) {
  const sp = practiceText.querySelector(`span[data-idx="${idx}"]`);
  if (!sp) return;
  sp.classList.remove('current','correct','wrong');
  if (!status) {
    // just remove coloring
    sp.classList.remove('current','correct','wrong');
  } else {
    sp.classList.add(status === 'correct' ? 'correct' : 'wrong');
  }
}

/* ---------- compute accuracy based on chars marked ---------- */
function computeAccuracy() {
  const spans = practiceText.querySelectorAll('span');
  let correct = 0;
  spans.forEach(s => { if (s.classList.contains('correct')) correct++; });
  const percent = Math.round((correct / spans.length) * 100);
  accuracyEl.textContent = percent + '%';
  return percent;
}

/* ---------- visual flash for key (physical press) ---------- */
function flashKey(keyName) {
  const id = localKeyMap[keyName];
  if (!id) return;
  const el = document.getElementById(id);
  if (!el) return;
  el.classList.add('visible','active');
  setTimeout(() => el.classList.remove('active'), 160);
}

/* ---------- flash wrong key red ---------- */
function flashWrong(keyName) {
  const id = localKeyMap[keyName];
  if (!id) return;
  const el = document.getElementById(id);
  if (!el) return;
  el.classList.add('visible','wrong');
  setTimeout(() => el.classList.remove('wrong'), 300);
}

/* ---------- simulate virtual press (on-screen click) ---------- */
function simulateVirtualPress(keyName) {
  // create synthetic event object to call onKeyDown logic
  const fakeEvt = { key: keyName.length === 1 ? keyName : keyName, preventDefault: ()=>{} };
  onKeyDown({ ...fakeEvt, key: keyName });
}

/* ---------- update glow on next expected key ---------- */
function updateNextKeyGlow() {
  // clear previous 'next' classes
  document.querySelectorAll('.vk').forEach(k => k.classList.remove('next','visible'));
  // make expected key visible (reduce 'invisible' feel)
  const nextChar = currentText[charIndex] || null;
  if (!nextChar) return;
  // compute which key corresponds
  const keyName = charToKeyId(nextChar);
  if (!keyName) return;
  const id = localKeyMap[keyName];
  if (!id) return;
  const el = document.getElementById(id);
  el.classList.add('next','visible');
}

/* ---------- char -> key mapping (simple) ---------- */
function charToKeyId(ch) {
  if (!ch) return null;
  if (ch === ' ') return 'space';
  // for uppercase letters map to lowercase keys
  const lower = ch.toLowerCase();
  // handle punctuation: .,;:'"!?- etc -> for many we map to their key label
  const map = {
    ',': ',', '.': '.', ';': ';', ':': ';', "'": "'", '"': "'", '?':'/', '/':'/', '!':'1', '-':'-'
  };
  if (map[ch]) return map[ch];
  if (/[a-z0-9`=\[\]\\;,'./-]/.test(lower)) return lower;
  return lower;
}

/* ---------- record attempt and evaluate pass conditions ---------- */
function recordAttempt(accuracy, errors, timeTaken) {
  attemptStats.push({accuracy, errors, timeTaken, timestamp:Date.now()});
  // update UI
  accuracyEl.textContent = accuracy + '%';
  passesEl.textContent = consecutivePasses;
}

/* ---------- evaluate pass and auto-advance logic ---------- */
function evaluatePass(accuracy, errors) {
  const L = lessons[lessonIndex];
  const needAcc = L.minAccuracy ?? 95;
  const maxErr = L.maxErrorsAllowed ?? Infinity;
  // if accuracy meets and errors <= allowed
  const pass = (accuracy >= needAcc && errors <= maxErr);
  const info = document.getElementById('feedback-info');
  if (pass) {
    consecutivePasses++;
    localStorage.setItem('skp-consec', consecutivePasses);
    passesEl.textContent = consecutivePasses;
    // require minConsecutivePasses
    const req = L.minConsecutivePasses ?? 1;
    if (consecutivePasses >= req) {
      // unlock next lesson
      showSuccessAndAdvance();
      return;
    } else {
      // inform user to repeat
      alert(`Good! ${accuracy}% — do ${req - consecutivePasses} more successful attempt(s) to advance.`);
      resetAttemptForRepeat();
    }
  } else {
    consecutivePasses = 0;
    localStorage.setItem('skp-consec', consecutivePasses);
    passesEl.textContent = consecutivePasses;
    // very strict: require retry until pass
    alert(`Attempt failed. Accuracy ${accuracy}%. Minimum required: ${needAcc}%. Please try again carefully.`);
    resetAttemptForRepeat();
  }
}

/* ---------- Reset attempt but keep consecutive passes if needed ---------- */
function resetAttemptForRepeat() {
  // reset stats for next attempt
  errorsCount = 0; errorsEl.textContent = errorsCount;
  charIndex = 0;
  renderPracticeText();
  startTimer();
  updateNextKeyGlow();
}

/* ---------- on success advance ---------- */
function showSuccessAndAdvance() {
  // inform user and advance
  stopTimer();
  alert('Lesson passed — advancing to next lesson.');
  // reset consec passes counter for next lesson
  localStorage.setItem('skp-consec','0');
  consecutivePasses = 0;
  // mark lesson progress and move to next
  const nextId = lessons[lessonIndex].nextId;
  if (!nextId) {
    // move to next index or end
    if (lessonIndex < lessons.length - 1) {
      loadLesson(lessonIndex + 1);
      saveState();
    } else {
      lessonTitle.textContent = 'All lessons complete — great job!';
      practiceText.innerHTML = '';
    }
  } else {
    // find index of nextId
    const idx = lessons.findIndex(l => l.id === nextId);
    if (idx >= 0) {
      loadLesson(idx);
      saveState();
    } else {
      // fallback
      loadLesson(lessonIndex + 1);
      saveState();
    }
  }
}

/* ---------- persistence ---------- */
function saveState() {
  localStorage.setItem('skp-lesson-state', JSON.stringify({ lessonIndex }));
}

/* ---------- misc helpers ---------- */
function sanitizeId(s) { return s.replace(/[^a-z0-9]+/gi,'_').toLowerCase(); }
function escapeHtml(s) { return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
</script>
</body>
</html>








<!--<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Keyboard Tutor | SmartKids Pro</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .key {
      width: 2.5rem;
      height: 2.5rem;
      margin: 0.2rem;
      background-color: #1e293b;
      color: white;
      border-radius: 0.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease-in-out;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }
    .key.active {
      background-color: #3b82f6;
      transform: scale(1.05);
    }
    .key.correct {
      background-color: #22c55e;
    }
    .key.wrong {
      background-color: #ef4444;
    }
  </style>
</head>
<body class="bg-slate-900 text-white min-h-screen flex flex-col items-center p-6">
  <h1 class="text-2xl font-bold mb-4">Keyboard Tutor</h1>
  
  <div id="lessonTitle" class="text-lg mb-4 font-semibold"></div>
  <div id="practiceText" class="text-xl mb-6 text-center tracking-widest"></div>
  
  <!-- Virtual Keyboard --
  <div id="keyboard" class="p-4 bg-slate-800 rounded-xl shadow-lg">
    <div class="flex justify-center">
      <div class="key">Q</div><div class="key">W</div><div class="key">E</div><div class="key">R</div><div class="key">T</div><div class="key">Y</div><div class="key">U</div><div class="key">I</div><div class="key">O</div><div class="key">P</div>
    </div>
    <div class="flex justify-center">
      <div class="key">A</div><div class="key">S</div><div class="key">D</div><div class="key">F</div><div class="key">G</div><div class="key">H</div><div class="key">J</div><div class="key">K</div><div class="key">L</div><div class="key">;</div>
    </div>
    <div class="flex justify-center">
      <div class="key">Z</div><div class="key">X</div><div class="key">C</div><div class="key">V</div><div class="key">B</div><div class="key">N</div><div class="key">M</div>
    </div>
  </div>

  <div class="mt-6">
    <button id="nextLessonBtn" class="bg-blue-600 px-4 py-2 rounded hover:bg-blue-500 hidden">Next Lesson</button>
  </div>

  <script src="keyboard.js"></script>
</body>
</html>
