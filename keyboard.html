<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Keyboard Tutor | SmartKids-Pro</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Virtual key base style */
    .key {
      @apply border rounded-lg p-2 w-10 h-10 flex items-center justify-center font-semibold transition-all duration-200 ease-in-out text-gray-700 bg-gray-100 opacity-20;
    }
    .key.visible {
      @apply opacity-100 bg-white shadow;
    }
    .key.correct {
      @apply bg-green-500 text-white;
    }
    .key.wrong {
      @apply bg-red-500 text-white;
    }
    .key.next {
      @apply bg-blue-200 animate-pulse;
    }
    .highlighted {
      background-color: #dbeafe; /* blue-100 */
      border-radius: 4px;
      padding: 0 2px;
    }
  </style>
</head>

<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen flex flex-col items-center py-10">
  <h1 class="text-3xl font-bold text-blue-800 mb-6">Keyboard Tutor</h1>

  <div id="activityContainer" class="w-full max-w-3xl bg-white rounded-2xl shadow-md p-6 text-center mb-10">
    <p class="text-gray-600">Loading practice...</p>
  </div>

  <div id="virtualKeyboard" class="grid gap-1 text-sm font-semibold"></div>

  <script>
    const container = document.getElementById("activityContainer");
    const keyboardContainer = document.getElementById("virtualKeyboard");
    let activities = [];
    let currentIndex = 0;
    let expected = "";
    let pos = 0;

    fetch("json-files/keyboard.json")
      .then(res => res.json())
      .then(data => {
        activities = data.activities;
        loadActivity();
        buildKeyboard();
      });

    function loadActivity() {
      if (currentIndex >= activities.length) {
        container.innerHTML = `<h2 class='text-2xl text-green-600 font-bold'>ðŸŽ‰ All Done!</h2>`;
        return;
      }
      expected = activities[currentIndex].expected;
      pos = 0;
      container.innerHTML = `
        <h2 class="text-xl font-semibold text-blue-700 mb-2">Practice ${currentIndex + 1}</h2>
        <p class="text-gray-800 mb-3">${activities[currentIndex].instruction}</p>
        <div id="practiceText" class="font-mono text-lg bg-gray-100 p-4 rounded">${highlightText()}</div>
        <p id="feedback" class="text-sm mt-2 font-semibold"></p>
      `;
      updateNextKey();
    }

    function highlightText() {
      let output = "";
      for (let i = 0; i < expected.length; i++) {
        if (i === pos) output += `<span class="highlighted">${expected[i]}</span>`;
        else output += expected[i];
      }
      return output;
    }

    function buildKeyboard() {
      const layout = [
        "1234567890",
        "qwertyuiop",
        "asdfghjkl",
        "zxcvbnm"
      ];
      keyboardContainer.innerHTML = "";
      layout.forEach(row => {
        const div = document.createElement("div");
        div.className = "flex justify-center space-x-1";
        for (let ch of row) {
          const key = document.createElement("div");
          key.className = "key";
          key.id = `key-${ch}`;
          key.textContent = ch;
          div.appendChild(key);
        }
        keyboardContainer.appendChild(div);
      });

      document.addEventListener("keydown", handleKey);
    }

    function handleKey(e) {
      const key = e.key.toLowerCase();
      const keyDiv = document.getElementById(`key-${key}`);
      if (!keyDiv) return;

      keyDiv.classList.add("visible"); // fade in when used

      if (key === expected[pos]?.toLowerCase()) {
        flashKey(keyDiv, "correct");
        pos++;
        document.getElementById("practiceText").innerHTML = highlightText();
        updateNextKey();

        if (pos >= expected.length) {
          document.getElementById("feedback").innerHTML = `<span class='text-green-600'>âœ… Excellent! Next activity loading...</span>`;
          setTimeout(() => {
            currentIndex++;
            loadActivity();
          }, 1200);
        }
      } else {
        flashKey(keyDiv, "wrong");
      }
    }

    function flashKey(el, type) {
      el.classList.add(type);
      setTimeout(() => el.classList.remove(type), 250);
    }

    function updateNextKey() {
      document.querySelectorAll(".key").forEach(k => k.classList.remove("next"));
      const nextChar = expected[pos]?.toLowerCase();
      const nextKey = document.getElementById(`key-${nextChar}`);
      if (nextKey) nextKey.classList.add("next");
    }
  </script>
</body>
</html>
